<?php

/**
 * Конфигурация парсинга чеков по банкам.
 * Определение банка по ключевым словам в тексте.
 * Для каждого банка — regex и ключи для извлечения суммы, даты и уникальных данных.
 */
return [
    /*
    |--------------------------------------------------------------------------
    | Порядок проверки банков (приоритет при множественных совпадениях)
    |--------------------------------------------------------------------------
    */
    'detection_order' => ['sber', 'tinkoff', 'alfabank', 'ozonbank', 'vtb', 'raiffeisen', 'gazprombank', 'default'],

    /*
    |--------------------------------------------------------------------------
    | Правила по банкам
    |--------------------------------------------------------------------------
    | detect_keywords — слова/фразы для определения банка (регистронезависимо)
    | sum_regex — regex для извлечения суммы (группа 1 = число)
    | date_regex — regex для извлечения даты (группы 1-3 = день, месяц, год; 4-6 = час, мин, сек)
    | unique_regex — regex для уникального ID операции
    | sum_keys — контекстные слова рядом с суммой (для скоринга)
    | date_keys — контекстные слова рядом с датой (для скоринга)
    */
    'banks' => [
        'sber' => [
            'name' => 'Сбербанк',
            'detect_keywords' => ['сбербанк', 'сбер', 'sberbank', 'п ao сбербанк'],
            'sum_keys' => ['итого', 'сумма', 'к оплате', 'сумма в валюте карты', 'сумма в валюте операции'],
            'date_keys' => ['дата', 'время', 'операции', 'дата и время', 'дата операции'],
            'sum_regex' => [
                '/итого[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
            ],
            'unique_regex' => [
                '/идентификатор\s+операции\s*[:\s]*([A-Z0-9]{20,50})/ui',
                '/квитанция\s*[№#]?\s*([0-9\-]{10,30})/ui',
            ],
        ],

        'tinkoff' => [
            'name' => 'Тинькофф',
            'detect_keywords' => ['тинькофф', 'тинькофф банк', 'т-банк', 'tinkoff', 'tbank'],
            'sum_keys' => ['сумма операции', 'оплачено', 'списано', 'итого', 'сумма'],
            'date_keys' => ['дата и время операции', 'дата операции', 'дата', 'время'],
            'sum_regex' => [
                '/оплачено[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/списано[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/сумма\s+операции[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{1,2})\s+(января|февраля|марта|апреля|мая|июня|июля|августа|сентября|октября|ноября|декабря)\s+(\d{4})/ui',
            ],
            'unique_regex' => [
                '/документ\s+по\s+операции[^\d]{0,20}(\d{6}_\d{6})/ui',
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
            ],
        ],

        'alfabank' => [
            'name' => 'Альфа-Банк',
            'detect_keywords' => ['альфа-банк', 'альфа банк', 'alfabank', 'alpha bank'],
            'sum_keys' => ['сумма', 'итого', 'к оплате', 'оплачено', 'списано'],
            'date_keys' => ['дата', 'время', 'операции', 'дата операции'],
            'sum_regex' => [
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/оплачено[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
            ],
            'unique_regex' => [
                '/квитанция\s*[№#]?\s*([0-9\-]{10,30})/ui',
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
            ],
        ],

        'ozonbank' => [
            'name' => 'Ozon Bank',
            'detect_keywords' => ['ozon bank', 'ozonbank', 'озон банк'],
            'sum_keys' => ['сумма', 'оплачено', 'списано', 'итого'],
            'date_keys' => ['дата', 'время', 'операции'],
            'sum_regex' => [
                '/оплачено[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/ui',
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
            ],
            'date_regex' => [
                '/(\d{4})[-.](\d{2})[-.](\d{2})\s+(\d{2}):(\d{2}):(\d{2})/u', // 2026-01-25 18:41:15
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
            ],
            'unique_regex' => [
                '/документ[^\d]{0,30}(\d{14})/ui', // ozonbank_document_20260125184115
                '/document[^\d]{0,30}(\d{14})/ui',
            ],
        ],

        'vtb' => [
            'name' => 'ВТБ',
            'detect_keywords' => ['втб', 'vtb', 'банк втб'],
            'sum_keys' => ['сумма', 'итого', 'к оплате'],
            'date_keys' => ['дата', 'время', 'операции'],
            'sum_regex' => [
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
            ],
            'unique_regex' => [
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
                '/квитанция\s*[№#]?\s*([0-9\-]{10,30})/ui',
            ],
        ],

        'raiffeisen' => [
            'name' => 'Райффайзен',
            'detect_keywords' => ['райффайзен', 'raiffeisen'],
            'sum_keys' => ['сумма', 'итого', 'к оплате'],
            'date_keys' => ['дата', 'время', 'операции'],
            'sum_regex' => [
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
            ],
            'unique_regex' => [
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
            ],
        ],

        'gazprombank' => [
            'name' => 'Газпромбанк',
            'detect_keywords' => ['газпромбанк', 'gazprombank', 'гпб'],
            'sum_keys' => ['сумма', 'итого', 'к оплате'],
            'date_keys' => ['дата', 'время', 'операции'],
            'sum_regex' => [
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
            ],
            'unique_regex' => [
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
            ],
        ],

        // Fallback для неизвестных банков
        'default' => [
            'name' => 'Другой банк',
            'detect_keywords' => [],
            'sum_keys' => ['итого', 'сумма', 'к оплате', 'оплачено', 'списано', 'всего'],
            'date_keys' => ['дата', 'время', 'операции', 'дата и время'],
            'sum_regex' => [
                '/итого[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/сумма[^\d]{0,40}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)\s*[₽РрPpруб\.]?/ui',
                '/оплачено[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/ui',
                '/списано[^\d]{0,50}(\d{1,3}(?:[\s\x{00A0}]\d{3})*(?:[.,]\d{2})?|\d+(?:[.,]\d{2})?)/ui',
            ],
            'date_regex' => [
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})\s+(\d{2}):(\d{2})/u',
                '/(\d{2})[\.\/](\d{2})[\.\/](\d{4})/u',
                '/(\d{4})[-.](\d{2})[-.](\d{2})\s+(\d{2}):(\d{2})/u',
            ],
            'unique_regex' => [
                '/идентификатор\s+операции\s*[:\s]*([A-Z0-9]{20,50})/ui',
                '/квитанция\s*[№#]?\s*([0-9\-]{10,30})/ui',
                '/номер\s+операции\s*[:\s]*([0-9A-Z\-]{8,40})/ui',
            ],
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Дополнительные паттерны для имени файла (если текст не содержит банк)
    |--------------------------------------------------------------------------
    */
    'filename_hints' => [
        'alfabank' => ['alfa', 'alfabank', 'alpha'],
        'ozonbank' => ['ozonbank', 'ozon_bank'],
        'tinkoff' => ['tinkoff', 'tbank', 'документ по операции'],
    ],
];
