# Проверка данных розыгрыша

## Проблема
На сайте отображаются неправильные данные для активного розыгрыша. Телеграм-бот показывает "Доступно мест: 57", но данные на сайте не совпадают.

## Что было исправлено

1. **Исправлен расчет выручки** в `app/Models/Raffle.php`:
   - Теперь используется итоговая сумма с учетом коррекции админом (`admin_edited_amount` или `corrected_amount`)
   - Ранее использовалась только `amount`, что могло давать неверные результаты

2. **Улучшена команда диагностики** `app/Console/Commands/DiagnoseRaffleCommand.php`:
   - Добавлена проверка активного розыгрыша (флаг `--active`)
   - Добавлено сравнение кэшированных значений с реальными данными из БД
   - Автоматическое обновление статистики при исправлении проблем

## Как проверить на сервере

### Вариант 1: Использовать команду диагностики (рекомендуется)

```bash
cd /var/www/auto.siteaccess.ru
php artisan raffle:diagnose --active --fix
```

Эта команда:
- Найдет активный розыгрыш для первого бота
- Сравнит кэшированные данные с реальными из БД
- Покажет все расхождения
- Автоматически обновит статистику (с флагом `--fix`)

### Вариант 2: Использовать PHP скрипт

```bash
cd /var/www/auto.siteaccess.ru
php diagnose_raffle_data.php
```

Этот скрипт выведет:
- Какой розыгрыш активен
- Кэшированные значения
- Реальные значения из БД
- Сравнение и автоматическое исправление при расхождениях

### Вариант 3: Проверить вручную через tinker

```bash
cd /var/www/auto.siteaccess.ru
php artisan tinker
```

Затем выполните:

```php
$bot = \App\Models\TelegramBot::first();
$active = \App\Models\Raffle::resolveActiveForBot($bot->id);
echo "Активный розыгрыш: ID={$active->id}, Название={$active->name}\n";
$active->updateStatistics();
$active->refresh();
echo "Участников: {$active->total_participants}\n";
echo "Выдано билетов: {$active->tickets_issued}\n";
echo "Доступно: " . ($active->total_slots - $active->tickets_issued) . "\n";
```

## Что проверить

1. **Какой розыгрыш активен?**
   - Должен быть только один розыгрыш со статусом `active` для каждого бота
   - Проверьте: `SELECT * FROM raffles WHERE status='active' AND telegram_bot_id=X;`

2. **Совпадают ли данные?**
   - Кэшированные значения в таблице `raffles` должны совпадать с реальными данными
   - Команда диагностики покажет все расхождения

3. **Правильно ли считается выручка?**
   - Теперь используется итоговая сумма с учетом коррекции админом
   - Проверьте чеки: `SELECT id, amount, corrected_amount, admin_edited_amount, review_status FROM checks WHERE raffle_id=X AND review_status='approved';`

## После исправления

После запуска команды с `--fix` или скрипта:
1. Обновите страницу `/raffles` в браузере
2. Проверьте, что данные совпадают с тем, что показывает бот
3. Убедитесь, что "Доступно мест" в боте совпадает с расчетом на сайте

## Примечание

Статистика автоматически обновляется при:
- Загрузке страницы розыгрышей (метод `index` в `RaffleController`)
- Получении активного розыгрыша (метод `active` в `RaffleController`)
- Одобрении чека
- Изменении заказа

Но если данные были изменены напрямую в БД или были проблемы, используйте команду диагностики для принудительного обновления.
