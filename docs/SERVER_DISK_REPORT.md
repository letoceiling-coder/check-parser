# Отчёт по занятости диска на сервере (80 ГБ, занято ~51 ГБ)

## Сводка по разделам

| Раздел | Размер | Описание |
|--------|--------|----------|
| **/var** | **45 ГБ** | Основной потребитель |
| /var/lib | 41 ГБ | В основном MySQL |
| /var/www | 3.4 ГБ | Сайты и приложения |
| /var/log | 161 МБ | Логи |
| /var/cache | 161 МБ | Кеш пакетов и др. |
| /usr | 3.8 ГБ | Системные программы |
| /swapfile | 2.1 ГБ | Файл подкачки (добавлен для сборки) |
| /root | 900 МБ | Домашняя директория root |

---

## 1. MySQL — ~40 ГБ (главная причина роста)

### Бинарные логи (binary logs) — **~24 ГБ**
- В `/var/lib/mysql/` лежит **240+ файлов** `binlog.000124` … `binlog.000363`
- Каждый файл ~100 МБ
- **Причина роста:** включён binary logging, логи **не удаляются** (нет настройки срока хранения)
- Логи пишутся постоянно при любых изменениях в БД (репликация/восстановление), поэтому диск постоянно заполняется

### Базы данных по размеру (данные + индексы)
| База | Размер | Примечание |
|------|--------|------------|
| **trend_api** | **16 ГБ** | Самая большая БД (TrendAgent) |
| al_db | 919 МБ | |
| dsc23ytp_check | 3.7 МБ | check-parser / auto.siteaccess |
| parser_bot_admin | 2.4 МБ | |
| messager | 1.3 МБ | |
| Остальные | < 2 МБ | |

### Рекомендации по MySQL
1. **Ограничить срок хранения бинарных логов** (например, 3–7 дней) — освободит ~20–24 ГБ и остановит постоянный рост.
2. При необходимости — архивировать/очищать старые данные в БД **trend_api** (16 ГБ).

---

## 2. /var/www — 3.4 ГБ

| Проект | Размер | Основное |
|--------|--------|----------|
| messager | 986 МБ | backend + chat-hub-design node_modules, downloads |
| auto.siteaccess.ru | 769 МБ | frontend (node_modules 407 МБ), vendor 240 МБ |
| messenger | 489 МБ | backend node_modules |
| AL | 313 МБ | |
| image-to-text-bot | 298 МБ | |
| trend-api | 221 МБ | |
| p-d-a-b.neeklo.ru | 136 МБ | |
| parser-traidagent | 127 МБ | |

**node_modules** по проектам: 407 МБ (auto), 355 МБ (messager backend), 354 МБ (chat-hub-design), 354 МБ (messenger), 120 МБ (messager frontend), 110 МБ (trend-api), 86 МБ (p-d-a-b) и др. — это нормально для Node.js, уменьшить можно только удалением неиспользуемых проектов или зависимостей.

---

## 3. Остальное

- **/var/log** — 161 МБ (journal, syslog, auth, nginx и др.) — в пределах нормы.
- **/var/lib/apt** — 446 МБ (кеш пакетов). Можно уменьшить: `apt clean`.
- **/root** — 900 МБ (в т.ч. /root/bot ~97 МБ).

---

## Почему диск постоянно заполняется

1. **MySQL binary logs** — пишутся при каждом изменении данных, старые не удаляются → рост на ~100 МБ каждые несколько минут при активной работе БД.
2. **Рост данных в БД** (особенно trend_api на 16 ГБ) — если приложение пишет много записей без архивации/очистки.
3. **Логи приложений** — при большом потоке логов без ротации могут расти (сейчас объём небольшой).

---

## Что сделано (на сервере)

1. **Очищены бинарные логи MySQL** (`PURGE BINARY LOGS BEFORE NOW();`) — занято MySQL уменьшилось с **~40 ГБ до ~17 ГБ** (освобождено **~23 ГБ**).
2. Включена автоочистка: `SET GLOBAL binlog_expire_logs_seconds = 259200` (хранить логи **3 дня**), чтобы диск снова не забивался.
3. Выполнена команда `apt-get clean`.

**Чтобы настройка binlog сохранялась после перезапуска MySQL**, на сервере добавьте в конфиг (например `/etc/mysql/mysql.conf.d/mysqld.cnf` в секцию `[mysqld]`):
```ini
binlog_expire_logs_seconds = 259200
```
После этого перезапустите MySQL: `systemctl restart mysql`.

---

## Что сделать при необходимости дальше

1. **Записать в конфиг MySQL** `binlog_expire_logs_seconds = 259200` (см. выше).
2. При нехватке места: анализ и архивация старых данных в БД **trend_api** (16 ГБ).
