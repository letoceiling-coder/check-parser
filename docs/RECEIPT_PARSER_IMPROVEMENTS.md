# Справка: улучшение определения суммы и даты из чеков (по материалам переписки с ChatGPT)

## О чём переписка

Обсуждалась задача: **точно извлекать сумму и дату из PDF/сканов чеков разных банков** с помощью OCR (Tesseract). Основные идеи:

1. **Не «PDF → Tesseract → regex»**, а пайплайн: тип PDF → предобработка → OCR → нормализация → кандидаты → валидация.
2. **Текстовый PDF** — не гнать в OCR, а вытаскивать текст через `pdftotext` / pdfplumber (точность 100%).
3. **Предобработка изображения** — контраст, бинаризация, шум — сильно повышает точность OCR.
4. **Поиск по контексту**, а не «все числа подряд»: дата — рядом с «дата», «время», вверху документа; сумма — рядом с «итого», «сумма», «всего».
5. **Исключать мусор**: не считать суммой числа рядом с «комиссия», «счёт», «телефон», длинные номера (счета, ID).
6. **Confidence score** и при нескольких кандидатах — понижать уверенность или отправлять на ручную проверку.
7. **Банк-специфичные правила** (опционально): разные наборы ключевых слов под Сбер, Тинькофф и т.д.

---

## Что уже есть в проекте (check-parser)

| Рекомендация из переписки | В проекте |
|---------------------------|-----------|
| Поиск суммы по ключам «итого», «сумма», «к оплате», «всего» | ✅ Есть: прямые паттерны и keywordPatterns |
| Поиск суммы с «руб» / «руб.» | ✅ Добавлено |
| Европейский формат «10.000» → 10000 | ✅ normalizeAmountString |
| Дата: DD.MM.YYYY HH:MM:SS в начале разбора | ✅ Числовой формат первым |
| Дата: русские месяцы («3 февраля 2026») | ✅ Есть + OCR-ошибки (фезраля и т.д.) |
| Исключение контекста: инн, бик, счёт, идентификатор | ✅ badContextWords |
| Скоринг кандидатов суммы (ключевые слова, валюта) | ✅ Есть, порог 6/8 |
| Предобработка изображения для Tesseract | ✅ preprocessImageForTesseract (grayscale, resize, sharpen, threshold) |
| PDF → изображение для OCR | ✅ convertPdfToImage (Imagick, 600 DPI) |
| Текстовый PDF без OCR | ❌ Нет — всегда рендер в картинку + Tesseract |
| Явный confidence в ответе парсера | ❌ Нет (логи и статус чека есть) |
| Выбор даты по позиции «в первых 20%» / «рядом со временем» | ⚠️ Частично: первый подходящий числовой формат |
| Банк-специфичные правила (sber/tinkoff) | ❌ Нет |
| pdftotext для текстовых PDF | ❌ Нет |

---

## Что можно взять и улучшить

### 1. Текстовый PDF (высший приоритет)

**Идея:** Если PDF содержит настоящий текст (а не скан), извлекать его через `pdftotext` (poppler-utils) или аналог — без OCR. Точность даты и суммы будет максимальной.

**Внедрение:**

- Перед `convertPdfToImage` проверять, есть ли в PDF текст (например, через `pdftotext -layout file.pdf - | head -c 500`).
- Если текст не пустой и достаточно длинный — парсить его через текущий `parsePaymentAmount()` и не вызывать Tesseract для этого PDF.

**Польза:** Чеки, сформированные банком как «текстовый PDF», будут обрабатываться без ошибок распознавания.

---

### 2. Дата: приоритет по контексту и позиции

**Идея из переписки:** Собирать все кандидаты дат, затем выбирать по правилам: в первых 20% текста, рядом со словом «дата»/«время», рядом с HH:MM.

**Сейчас:** Берётся первое совпадение по числовому формату или по формату «N месяца ГГГГ».

**Улучшение:**

- Искать все вхождения дат (одним regex), для каждого сохранять позицию в тексте (offset или «первая/вторая половина»).
- Ранжировать: +2 если в первой четверти текста, +2 если рядом есть «дата»/«время»/«операции», +1 если рядом HH:MM.
- Выбирать кандидата с максимальным баллом. Так уменьшится выбор даты из «подвала» чека (например, даты печати) вместо даты операции.

---

### 3. Сумма: явные маркеры «оплачено» / «списано»

**Идея:** Добавить в ключевые слова для поиска суммы: «оплачено», «списано» (как в переписке).

**Сейчас:** Уже есть «итого», «сумма», «к оплате», «всего», «сумма перевода», «перевод».

**Улучшение:** Добавить в массив ключевых слов и в паттерны строки вида «Оплачено … 1 500 ₽», «Списано … 1 500 ₽» (по тому же regex суммы, что и для «итого»/«сумма»).

---

### 4. Confidence и ручная проверка

**Идея:** Парсер возвращает не только `date` и `amount`, но и `confidence` (0.0–1.0). При низком confidence помечать чек как «требует проверки» или предлагать админу подтвердить.

**Внедрение:**

- В `parsePaymentAmount()` считать балл: найдена дата по контексту (+0.4), сумма по ключевому слову (+0.4), один кандидат даты и один суммы (+0.2). При нескольких кандидатах — уменьшать балл.
- Возвращать в структуре чека поле `parsing_confidence` и в админке/логике использовать его для флага «нужна проверка».

**Польза:** Меньше тихих ошибок, больше явных случаев для ручной проверки.

---

### 5. Предобработка изображения (уже близко к рекомендациям)

**Идея из переписки:** Бинаризация (Otsu), лёгкое сглаживание (medianBlur) для уменьшения шума.

**Сейчас:** В `preprocessImageForTesseract` уже есть grayscale, resize, sharpen, adaptive threshold. PDF рендерится в 600 DPI.

**Улучшение (по желанию):** Добавить опциональный шаг medianBlur (например, 2–3) перед бинаризацией для сильно зашумлённых сканов. Имеет смысл тестировать на реальных «плохих» чеках.

---

### 6. Банк-специфичные правила (опционально)

**Идея:** Конфиг по банкам: разные наборы ключевых слов для суммы/даты (например, для Тинькофф — свои подписи полей).

**Внедрение:**

- Определять банк по подстроке в тексте («сбербанк», «тинькофф», «альфа» и т.д.).
- Использовать отдельные списки ключевых слов и приоритеты только при необходимости; для старта можно оставить один общий набор (как сейчас), а банк сохранять в метаданных чека для аналитики и будущего расширения.

---

## Итоговая таблица действий

| Действие | Сложность | Эффект для точности суммы/даты |
|----------|-----------|----------------------------------|
| Текстовый PDF через pdftotext | Средняя | Очень высокий для таких чеков |
| Выбор даты по контексту/позиции | Средняя | Выше правильных дат операции |
| Маркеры «оплачено»/«списано» для суммы | Низкая | Плюс ещё формат чеков |
| Confidence в ответе парсера | Низкая | Лучше контроль качества |
| Банк-специфика (опционально) | Низкая–средняя | Точечно по проблемным банкам |
| Доп. предобработка (blur и т.д.) | Низкая | Только на плохих сканах |

Рекомендуемый порядок: сначала **текстовый PDF**, затем **контекстный выбор даты** и **«оплачено»/«списано»**, потом **confidence** и при необходимости банк-специфика и тонкая предобработка.

Проект: **PHP/Laravel**, парсинг в `TelegramWebhookController::parsePaymentAmount()`, PDF → изображение в `convertPdfToImage()`, предобработка в `preprocessImageForTesseract()`.
